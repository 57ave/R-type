name: CI/CD Pipeline

on:
  push:
    branches-ignore:
      - "ga-ignore-**"
  pull_request:
    branches-ignore:
      - "ga-ignore-**"

env:
  MIRROR_URL: git@github.com:EpitechPromo2028/B-OOP-400-PAR-4-1-raytracer-gustave.delecroix.git
  BUILD_TYPE: Release
  CPM_SOURCE_CACHE: ${{ github.workspace }}/cpm_cache

jobs:
  install_dependencies:
    runs-on: ubuntu-latest
    container:
      image: epitechcontent/epitest-docker:latest
    outputs:
      cache-hit: ${{ steps.cache-cpm.outputs.cache-hit }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Cache CPM dependencies
        id: cache-cpm
        uses: actions/cache@v3
        with:
          path: |
            ${{ env.CPM_SOURCE_CACHE }}
            ~/.cache/CPM
          key: ${{ runner.os }}-cpm-${{ hashFiles('**/CMakeLists.txt', '**/cmake/CPM.cmake') }}
          restore-keys: |
            ${{ runner.os }}-cpm-

      - name: Install system dependencies
        run: |
          apt-get update
          apt-get install -y \
            libxrandr-dev libxcursor-dev libxi-dev libudev-dev \
            libopenal-dev libflac-dev libvorbis-dev \
            libgl1-mesa-dev libegl1-mesa-dev \
            libfreetype6-dev libx11-dev libx11-xcb-dev \
            libxcb-randr0-dev libxcb-image0-dev libxcb-keysyms1-dev \
            libglu1-mesa-dev \
            lua5.3 liblua5.3-dev  # Lua for sol2
            libasio-dev  # System ASIO to avoid deprecation warnings
            clang-tidy cppcheck  # Static analysis tools

  check_program_compilation:
    runs-on: ubuntu-latest
    needs: install_dependencies
    strategy:
      matrix:
        build_type: [Release]
        build_all: [true]
        include:
          - build_type: Release
            build_all: true
            build_name: "all-components"
    container:
      image: epitechcontent/epitest-docker:latest
    env:
      ASIO_STANDALONE: 1  # Use standalone ASIO to avoid system conflicts
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Restore CPM cache
        uses: actions/cache@v3
        with:
          path: |
            ${{ env.CPM_SOURCE_CACHE }}
            ~/.cache/CPM
          key: ${{ runner.os }}-cpm-${{ hashFiles('**/CMakeLists.txt', '**/cmake/CPM.cmake') }}

      - name: Configure CMake
        run: |
          mkdir -p build-${{ matrix.build_name }}
          cd build-${{ matrix.build_name }}
          cmake .. \
            -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
            -DCMAKE_CXX_FLAGS="-Wno-deprecated -Wno-unused-parameter -Wno-unused-variable" \
            -DBUILD_CLIENT=${{ matrix.build_all }} \
            -DBUILD_SERVER=${{ matrix.build_all }} \
            -DBUILD_GAME=${{ matrix.build_all }} \
            -DBUILD_TESTS=OFF \
            -DCPM_SOURCE_CACHE="${{ env.CPM_SOURCE_CACHE }}"

      - name: Build project
        run: |
          cd build-${{ matrix.build_name }}
          make -j$(nproc) 2>&1 | tee build.log || (echo "Build failed, checking for specific errors:" && cat build.log && exit 1)

      - name: Check build artifacts
        run: |
          echo "Build artifacts in build-${{ matrix.build_name }}:"
          find build-${{ matrix.build_name }} -type f -name "*.so" -o -name "*.a" -o -name "RType*" | xargs -I {} ls -la {}
          
          # Check if key executables were built
          if [[ "${{ matrix.build_all }}" == "true" ]]; then
            test -f build-${{ matrix.build_name }}/server/RType_server && echo "✓ Server executable found" || echo "✗ Server executable missing"
            test -f build-${{ matrix.build_name }}/client/RType_client && echo "✓ Client executable found" || echo "✗ Client executable missing"
            test -f build-${{ matrix.build_name }}/game/RType_game && echo "✓ Game executable found" || echo "✗ Game executable missing"
          fi

      - name: Upload build logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: build-logs-${{ matrix.build_name }}
          path: build-${{ matrix.build_name }}/build.log

  run_tests:
    runs-on: ubuntu-latest
    needs: [install_dependencies, check_program_compilation]
    container:
      image: epitechcontent/epitest-docker:latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Restore CPM cache
        uses: actions/cache@v3
        with:
          path: |
            ${{ env.CPM_SOURCE_CACHE }}
            ~/.cache/CPM
          key: ${{ runner.os }}-cpm-${{ hashFiles('**/CMakeLists.txt', '**/cmake/CPM.cmake') }}

      - name: Configure CMake with tests
        run: |
          mkdir -p build-tests
          cd build-tests
          cmake .. \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_CXX_FLAGS="-Wno-deprecated -Wno-unused-parameter -Wno-unused-variable" \
            -DBUILD_CLIENT=OFF \
            -DBUILD_SERVER=OFF \
            -DBUILD_GAME=OFF \
            -DBUILD_TESTS=ON \
            -DCPM_SOURCE_CACHE="${{ env.CPM_SOURCE_CACHE }}"

      - name: Build tests
        run: |
          cd build-tests
          cmake --build . --config Debug --target unit_tests -- -j$(nproc) 2>&1 | tee test_build.log || (echo "Test build failed:" && cat test_build.log && exit 1)

      - name: Run unit tests
        run: |
          cd build-tests
          timeout 60s ./tests/unit_tests --gtest_output=xml:test_results.xml || echo "Tests may have timed out or failed"

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            build-tests/test_results.xml
            build-tests/test_build.log

  static_analysis:
    runs-on: ubuntu-latest
    needs: install_dependencies
    container:
      image: epitechcontent/epitest-docker:latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run cppcheck
        run: |
          echo "Running cppcheck analysis..."
          cppcheck \
            --enable=warning,style,performance,portability \
            --suppress=missingIncludeSystem \
            --suppress=unmatchedSuppression \
            --inline-suppr \
            --error-exitcode=0 \
            -I engine/include \
            -I engine/modules/shootemup/include \
            -I server/include \
            -I client/include \
            -I game/include \
            --xml \
            --output-file=cppcheck_results.xml \
            engine/src/ server/src/ client/src/ game/src/ 2> cppcheck.log
          
          echo "=== Cppcheck summary ==="
          cppcheck --errorlist | grep -E "(warning|error|style)" || true

      - name: Run clang-tidy
        run: |
          echo "Running clang-tidy analysis..."
          # Create compile_commands.json if needed
          mkdir -p build-analysis
          cd build-analysis
          cmake .. \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
            -DBUILD_TESTS=OFF
          
          # Run clang-tidy on key files
          find ../engine/src -name "*.cpp" | head -20 | xargs -I {} clang-tidy {} \
            -checks='-*,bugprone-*,performance-*,modernize-*,readability-*' \
            --warnings-as-errors='*' \
            -- -I../engine/include -I../build-analysis/_deps 2>&1 | tee clang_tidy.log || true

      - name: Upload analysis results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: static-analysis
          path: |
            cppcheck_results.xml
            cppcheck.log
            build-analysis/clang_tidy.log

  server_integration_test:
    runs-on: ubuntu-latest
    needs: [check_program_compilation, run_tests]
    container:
      image: epitechcontent/epitest-docker:latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build server only
        run: |
          mkdir -p build-server-test
          cd build-server-test
          cmake .. \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_FLAGS="-Wno-deprecated -Wno-unused-parameter -Wno-unused-variable" \
            -DBUILD_CLIENT=OFF \
            -DBUILD_SERVER=ON \
            -DBUILD_GAME=OFF \
            -DBUILD_TESTS=OFF
          cmake --build . --target RType_server -- -j$(nproc)

      - name: Test server startup
        timeout-minutes: 2
        run: |
          cd build-server-test
          echo "Starting server..."
          ./server/RType_server --port 4242 > server.log 2>&1 &
          SERVER_PID=$!
          
          sleep 5
          
          if ps -p $SERVER_PID > /dev/null; then
            echo "✓ Server process is running"
            
            # Check if server is listening
            if netstat -tuln | grep :4242; then
              echo "✓ Server is listening on port 4242"
            else
              echo "✗ Server not listening on expected port"
              cat server.log
              exit 1
            fi
            
            # Graceful shutdown
            kill $SERVER_PID
            wait $SERVER_PID 2>/dev/null || true
            echo "✓ Server shutdown cleanly"
          else
            echo "✗ Server process died"
            cat server.log
            exit 1
          fi

      - name: Upload server logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: server-test-logs
          path: build-server-test/server.log

  push_to_mirror:
    needs: [check_program_compilation, run_tests, server_integration_test]
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Push to mirror
        uses: pixta-dev/repository-mirroring-action@v1
        with:
          target_repo_url: ${{ env.MIRROR_URL }}
          ssh_private_key: ${{ secrets.M4_MAC_PRIVATE_KEY }}