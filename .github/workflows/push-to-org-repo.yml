name: CI/CD Pipeline

on:
  push:
    branches-ignore:
      - "ga-ignore-**"
  pull_request:
    branches-ignore:
      - "ga-ignore-**"

env:
  MIRROR_URL: git@github.com:EpitechPromo2028/B-OOP-400-PAR-4-1-raytracer-gustave.delecroix.git
  BUILD_TYPE: Release
  CPM_SOURCE_CACHE: ${{ github.workspace }}/cpm_cache

jobs:
  setup_and_build:
    runs-on: ubuntu-latest
    container:
      image: epitechcontent/epitest-docker:latest
    strategy:
      matrix:
        target: [engine, client, server, game]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install build dependencies
        run: |
          apt-get update
          apt-get install -y \
            libxrandr-dev libxcursor-dev libxi-dev libudev-dev \
            libopenal-dev libflac-dev libvorbis-dev \
            libgl1-mesa-dev libegl1-mesa-dev \
            libfreetype6-dev libx11-dev libx11-xcb-dev \
            libxcb-randr0-dev libxcb-image0-dev libxcb-keysyms1-dev \
            libglu1-mesa-dev \
            lua5.3 liblua5.3-dev \
            git cmake build-essential pkg-config \
            libasio-dev

      - name: Configure CMake
        run: |
          mkdir -p build-${{ matrix.target }}
          cd build-${{ matrix.target }}
          
          # Set appropriate build options based on target
          if [ "${{ matrix.target }}" = "engine" ]; then
            BUILD_CLIENT=OFF
            BUILD_SERVER=OFF
            BUILD_GAME=OFF
          elif [ "${{ matrix.target }}" = "client" ]; then
            BUILD_CLIENT=ON
            BUILD_SERVER=OFF
            BUILD_GAME=OFF
          elif [ "${{ matrix.target }}" = "server" ]; then
            BUILD_CLIENT=OFF
            BUILD_SERVER=ON
            BUILD_GAME=OFF
          else
            BUILD_CLIENT=OFF
            BUILD_SERVER=OFF
            BUILD_GAME=ON
          fi
          
          cmake .. \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DCMAKE_CXX_FLAGS="-Wno-error=deprecated -Wno-deprecated-declarations -Wno-unused-parameter -Wno-unused-variable -Wno-overloaded-virtual" \
            -DBUILD_CLIENT=$BUILD_CLIENT \
            -DBUILD_SERVER=$BUILD_SERVER \
            -DBUILD_GAME=$BUILD_GAME \
            -DBUILD_TESTS=OFF \
            -DASIO_STANDALONE=ON

      - name: Build specific target
        run: |
          cd build-${{ matrix.target }}
          make -j$(nproc) 2>&1 | tee build.log || { echo "Build failed for ${{ matrix.target }}"; cat build.log; exit 1; }

      - name: Check build artifacts
        run: |
          echo "=== Build artifacts for ${{ matrix.target }} ==="
          find build-${{ matrix.target }} -type f \( -name "*.so" -o -name "*.a" -o -name "RType*" -o -name "*Test*" \) | xargs -I {} ls -la {} || true
          
          # Check for specific executables
          if [ "${{ matrix.target }}" = "server" ]; then
            test -f build-${{ matrix.target }}/server/RType_server && echo "✓ Server executable built successfully" || echo "✗ Server executable not found"
          elif [ "${{ matrix.target }}" = "client" ]; then
            test -f build-${{ matrix.target }}/client/RType_client && echo "✓ Client executable built successfully" || echo "✗ Client executable not found"
          elif [ "${{ matrix.target }}" = "game" ]; then
            test -f build-${{ matrix.target }}/game/RType_game && echo "✓ Game executable built successfully" || echo "✗ Game executable not found"
          fi

      - name: Upload build logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ matrix.target }}
          path: |
            build-${{ matrix.target }}/build.log
            build-${{ matrix.target }}/CMakeCache.txt

  build_all_in_one:
    runs-on: ubuntu-latest
    container:
      image: epitechcontent/epitest-docker:latest
    needs: setup_and_build
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          apt-get update
          apt-get install -y \
            libxrandr-dev libxcursor-dev libxi-dev libudev-dev \
            libopenal-dev libflac-dev libvorbis-dev \
            libgl1-mesa-dev libegl1-mesa-dev \
            libfreetype6-dev libx11-dev libx11-xcb-dev \
            libxcb-randr0-dev libxcb-image0-dev libxcb-keysyms1-dev \
            libglu1-mesa-dev \
            lua5.3 liblua5.3-dev

      - name: Build complete project
        run: |
          mkdir -p build-complete
          cd build-complete
          cmake .. \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DCMAKE_CXX_FLAGS="-Wno-error=deprecated -Wno-deprecated-declarations -Wno-unused-parameter -Wno-unused-variable -Wno-overloaded-virtual" \
            -DBUILD_CLIENT=ON \
            -DBUILD_SERVER=ON \
            -DBUILD_GAME=ON \
            -DBUILD_TESTS=OFF \
            -DASIO_STANDALONE=ON
          
          make -j$(nproc) 2>&1 | tee build_complete.log || { echo "Complete build failed"; cat build_complete.log; exit 1; }

      - name: Verify all executables
        run: |
          echo "=== Complete build verification ==="
          test -f build-complete/server/RType_server && echo "✓ Server executable found" || echo "✗ Server executable missing"
          test -f build-complete/client/RType_client && echo "✓ Client executable found" || echo "✗ Client executable missing"
          test -f build-complete/game/RType_game && echo "✓ Game executable found" || echo "✗ Game executable missing"
          
          echo ""
          echo "=== Library files ==="
          find build-complete -name "*.so" -o -name "*.a" | xargs -I {} ls -la {} || true

  run_tests:
    runs-on: ubuntu-latest
    container:
      image: epitechcontent/epitest-docker:latest
    needs: build_all_in_one
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install test dependencies
        run: |
          apt-get update
          apt-get install -y \
            lua5.3 liblua5.3-dev \
            libgtest-dev

      - name: Build and run tests
        run: |
          mkdir -p build-tests
          cd build-tests
          cmake .. \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_CXX_FLAGS="-Wno-error=deprecated -Wno-deprecated-declarations" \
            -DBUILD_CLIENT=OFF \
            -DBUILD_SERVER=OFF \
            -DBUILD_GAME=OFF \
            -DBUILD_TESTS=ON \
            -DASIO_STANDALONE=ON
          
          make -j$(nproc) unit_tests 2>&1 | tee test_build.log || { echo "Test build failed"; cat test_build.log; exit 1; }
          
          echo "=== Running tests ==="
          timeout 30s ./tests/unit_tests --gtest_output=xml:test_results.xml || echo "Tests completed (may have timed out)"

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            build-tests/test_results.xml
            build-tests/test_build.log

  server_integration_test:
    runs-on: ubuntu-latest
    container:
      image: epitechcontent/epitest-docker:latest
    needs: build_all_in_one
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build server standalone
        run: |
          mkdir -p build-server-test
          cd build-server-test
          cmake .. \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DCMAKE_CXX_FLAGS="-Wno-error=deprecated -Wno-deprecated-declarations" \
            -DBUILD_CLIENT=OFF \
            -DBUILD_SERVER=ON \
            -DBUILD_GAME=OFF \
            -DBUILD_TESTS=OFF \
            -DASIO_STANDALONE=ON
          
          make -j$(nproc) RType_server 2>&1 | tee server_build.log || { echo "Server build failed"; cat server_build.log; exit 1; }

      - name: Test server basic functionality
        timeout-minutes: 2
        run: |
          cd build-server-test
          
          echo "=== Starting server on port 4242 ==="
          ./server/RType_server --port 4242 --max-clients 4 > server_output.log 2>&1 &
          SERVER_PID=$!
          
          # Wait for server to start
          sleep 10
          
          if ! ps -p $SERVER_PID > /dev/null; then
            echo "✗ Server process died immediately"
            cat server_output.log
            exit 1
          fi
          
          echo "✓ Server process is running (PID: $SERVER_PID)"
          
          # Check if server is listening
          if ss -tuln | grep :4242; then
            echo "✓ Server is listening on port 4242"
          else
            echo "✗ Server is not listening on port 4242"
            cat server_output.log
            kill $SERVER_PID 2>/dev/null || true
            exit 1
          fi
          
          # Try to connect to the server
          echo "=== Testing server connection ==="
          timeout 5s nc -z localhost 4242 && echo "✓ Can connect to server" || echo "⚠ Connection test inconclusive"
          
          # Graceful shutdown
          echo "=== Shutting down server ==="
          kill $SERVER_PID
          sleep 2
          
          if ! ps -p $SERVER_PID > /dev/null; then
            echo "✓ Server shut down cleanly"
          else
            echo "⚠ Server still running, forcing kill"
            kill -9 $SERVER_PID 2>/dev/null || true
          fi

      - name: Upload server test logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: server-integration-logs
          path: |
            build-server-test/server_build.log
            build-server-test/server_output.log

  push_to_mirror:
    runs-on: ubuntu-latest
    needs: [build_all_in_one, run_tests, server_integration_test]
    if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Push to mirror
        uses: pixta-dev/repository-mirroring-action@v1
        with:
          target_repo_url: ${{ env.MIRROR_URL }}
          ssh_private_key: ${{ secrets.M4_MAC_PRIVATE_KEY }}